name: writer_lock

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  enforce_writer_trailer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify commit trailer
        shell: bash
        run: |
          set -euo pipefail
          trailer="X-GitNanu-Writer: gitnanu"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.event.pull_request.head.sha }}"
            commits=$(git rev-list --no-merges "${base}..${head}")
          else
            # on push, validate last commit only
            commits=$(git rev-parse HEAD)
          fi

          echo "Checking commits:"
          echo "$commits"

          for c in $commits; do
            msg=$(git log -1 --pretty=%B "$c")
            echo "---- commit $c ----"
            echo "$msg"
            echo "-------------------"
            echo "$msg" | grep -q "$trailer" || {
              echo "FAIL: missing trailer in commit $c"
              exit 1
            }
          done

          echo "PASS: writer trailer present"
