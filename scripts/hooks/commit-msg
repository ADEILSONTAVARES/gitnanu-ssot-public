#!/bin/bash
MSG_FILE="$1"

COMPONENT="$(git config user.component || true)"
if [ "$COMPONENT" != "gitnanu" ]; then
  echo "❌ BLOCKED: Only GitNanu can commit (git config user.component=gitnanu required)"
  echo "Attempted by: ${COMPONENT:-unknown}"
  echo "$(date -u) attempted_by=${COMPONENT:-unknown} reason=component_mismatch" >> evidence/UNAUTHORIZED_WRITE_ATTEMPTS.log
  exit 1
fi

if ! grep -q "X-GitNanu-Writer: gitnanu" "$MSG_FILE"; then
  echo "❌ BLOCKED: Missing commit trailer: X-GitNanu-Writer: gitnanu"
  echo "$(date -u) attempted_by=${COMPONENT:-unknown} reason=missing_trailer" >> evidence/UNAUTHORIZED_WRITE_ATTEMPTS.log
  exit 1
fi

exit 0
