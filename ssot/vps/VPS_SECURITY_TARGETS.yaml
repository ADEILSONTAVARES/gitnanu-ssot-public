vps_security_targets:
  version: "v1"
  scope:
    - "GitNanu VPS terminal-write host hardening"
    - "Mirror push to GitHub after audit"
  ssh:
    port_policy:
      not_allowed_ports: [22]
      allowed_ports_example: [2222]
    require_key_auth_only: true
    sshd_config_targets:
      PermitRootLogin: "no"
      PasswordAuthentication: "no"
      PubkeyAuthentication: "yes"
      ChallengeResponseAuthentication: "no"
      UsePAM: "yes"
    allow_users_example:
      - "gitnanu"
  firewall:
    ufw:
      default_incoming: "deny"
      default_outgoing: "allow"
      allow_ports_example:
        - "2222/tcp"
        - "443/tcp"
  fail2ban:
    enabled: true
    jail_sshd:
      enabled: true
      maxretry: 3
      bantime_seconds: 3600
  user:
    non_root_required: true
    service_user_example: "gitnanu"
    docker_group_optional: true
  auditd:
    enabled: true
    rule_minimum:
      watch_paths_example:
        - "/home/gitnanu"
  backup:
    daily_backup_required: true
    retention_days_example: 30
    offsite_required: true
    restore_test_monthly_required: true
  operations:
    multi_device_lock_required: true
    conflict_resolution: "manual_only"
  push_policy_ref:
    file: "ssot/policies/PUSH_POLICY.yaml"
  terminal_policy_ref:
    file: "ssot/terminal/TERMINAL_POLICY.yaml"

# ===== Policies =====
cat > ssot/policies/PUSH_POLICY.yaml <<'EOF'
push_policy:
  version: "v1"
  rule: "push only after audit + evidence"
  require:
    - "doctor1_pass"
    - "doctor2_pass"
    - "evidence_present"
  block_if:
    - "secrets_detected"
    - "gate_failed"
    - "baseline_tag_mismatch"
  notes:
    - "No tokens, keys, env files in repo"

cat > ssot/policies/BRANCH_PROTECTION_POLICY.yaml <<'EOF'
branch_protection_policy:
  version: "v1"
  branch: "main"
  require_status_checks: true
  require_linear_history: true
  allow_force_push: false
  allow_deletions: false
  recommended:
    - "signed_commits"

cat > ssot/terminal/TERMINAL_POLICY.yaml <<'EOF'
terminal_policy:
  version: "v1"
  require_approval: true
  session_timeout_minutes: 30
  idle_disconnect_minutes: 15

  dangerous_patterns_block:
    - "rm -rf"
    - "mkfs"
    - "dd if="
    - ">: /dev/"
    - "chmod 777 /"
    - "chown -R root"

  allowed_commands_whitelist_example:
    - "git"
    - "bash"
    - "sh"
    - "python3"
    - "node"
    - "npm"
    - "docker"

  dry_run_required_for:
    - "delete"
    - "drop"
    - "remove"

  logging:
    command_log_required: true
    public_evidence_must_be_sanitized: true

cat > ssot/device/LOCK_POLICY.yaml <<'EOF'
lock_policy:
  version: "v1"
  lock_scope:
    - "repo_sync"
    - "push_pipeline"
  lock_timeout_ms_example: 60000
  conflict_resolution: "manual_only"
  notify_channels_example:
    - "email"
    - "push"

cat > ssot/device/DEVICE_REGISTRY.example.yaml <<'EOF'
device_registry_example:
  version: "v1"
  devices:
    - device_id: "iphone_example"
      type: "mobile"
      trusted: true
      last_seen_iso_example: "2026-02-17T14:30:00Z"
    - device_id: "macbook_example"
      type: "desktop"
      trusted: true
      last_seen_iso_example: "2026-02-17T15:00:00Z"

# ===== Templates =====
cat > templates/vps/sshd_config.snippet <<'EOF'
# sshd_config snippet (example)
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
ChallengeResponseAuthentication no
UsePAM yes
# Port <PORT_EXAMPLE_NOT_22>

cat > templates/vps/fail2ban/jail.local.example <<'EOF'
[sshd]
enabled = true
maxretry = 3
bantime = 3600

cat > templates/vps/ufw_rules.example <<'EOF'
# UFW example
ufw default deny incoming
ufw default allow outgoing
ufw allow <SSH_PORT_EXAMPLE>/tcp
ufw allow 443/tcp
ufw enable

cat > templates/vps/auditd/gitnanu.rules.example <<'EOF'
# auditd rules example
-w /home/gitnanu -p wa -k gitnanu_activity

cat > templates/vps/cron/backup.cron.example <<'EOF'
# Daily backup example at 02:00
0 2 * * * /home/gitnanu/scripts/backup.sh

cat > templates/vps/gitnanu.env.example <<'EOF'
# Example env keys (NO values here)
GITHUB_TOKEN=<TOKEN>
ENCRYPTION_KEY=<KEY>
DATABASE_URL=<URL>
OPENAI_API_KEY=<KEY>

# ===== Runbooks =====
cat > docs/runbooks/RUNBOOK_VPS_COMPROMISED.md <<'EOF'
# RUNBOOK: VPS COMPROMETIDA (GitNanu)

## Detecção
- login desconhecido
- comandos suspeitos
- alertas de brute-force/Fail2Ban

## Resposta imediata
1) Isolar a VPS (rede)
2) Snapshot do estado
3) Coletar logs (auditd, auth, ssh)
4) Revogar chaves e tokens (fora do repo público)
5) Restaurar de backup limpo

## Pós-incidente
- identificar vetor
- corrigir configuração
- registrar evidência sanitizada (sem dados sensíveis)

cat > docs/runbooks/RUNBOOK_BACKUP_RESTORE.md <<'EOF'
# RUNBOOK: BACKUP E RESTORE

## Regras
- Backup diário
- Offsite obrigatório
- Restore test mensal

## Evidência
- guardar apenas relatório sanitizado no repo público

cat > docs/runbooks/RUNBOOK_TOKEN_ROTATION.md <<'EOF'
# RUNBOOK: ROTAÇÃO DE TOKENS E CHAVES

## Princípio
- Rotação periódica reduz risco
- Nunca armazenar tokens no SSOT_PUBLIC

## Processo
1) Gerar novo token/chave
2) Atualizar ambiente privado (fora do repo público)
3) Testar conexões
4) Revogar token/chave antiga
5) Registrar evidência sanitizada (sem valores)

cat > docs/runbooks/RUNBOOK_MULTI_DEVICE_SYNC.md <<'EOF'
# RUNBOOK: MULTI-DEVICE SYNC

## Regras
- Sync exige lock
- Conflito é manual
- Sem lock, não existe garantia

## Procedimento
1) Adquirir lock
2) Verificar estado local limpo
3) Pull
4) Rodar gates + Doctor
5) Gerar evidência
6) Push
7) Liberar lock

cat > docs/runbooks/RUNBOOK_CONFLICT_RESOLUTION.md <<'EOF'
# RUNBOOK: RESOLUÇÃO DE CONFLITO (manual)

## Princípio
- Não existe auto-merge para SSOT
- Conflito deve ser resolvido com revisão humana

## Procedimento
1) Identificar arquivos conflitantes
2) Comparar versões e escolher a correta
3) Rodar gates e Doctor
4) Gerar evidência
5) Push auditado

# ===== Evidence Example =====
cat > evidence/public/VPS_GATE_REPORT.example.md <<'EOF'
# VPS_GATE_REPORT (example, sanitized)
- timestamp_iso: 2026-02-17T00:00:00Z
- repo_commit: <COMMIT>
- result: PASS
- checks:
  - ssh_gate: PASS
  - firewall_gate: PASS
  - fail2ban_gate: PASS
  - auditd_gate: PASS
  - backup_gate: PASS
  - restore_test_gate: PASS
- notes:
  - "No secrets printed"
  - "No raw auth/audit logs included"

# ===== Gates (dry-only public) =====
cat > scripts/vps/ssh_gate.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
MODE="${1:-dry}"
echo "== SSH_GATE =="
if [ "$MODE" = "dry" ]; then
  test -f ssot/vps/VPS_SECURITY_TARGETS.yaml
  echo "PASS: dry"
  exit 0
fi
echo "STOP: vps mode is private-only"
exit 2

cat > scripts/vps/firewall_gate.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
MODE="${1:-dry}"
echo "== FIREWALL_GATE =="
if [ "$MODE" = "dry" ]; then
  test -f templates/vps/ufw_rules.example
  echo "PASS: dry"
  exit 0
fi
echo "STOP: vps mode is private-only"
exit 2

cat > scripts/vps/fail2ban_gate.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
MODE="${1:-dry}"
echo "== FAIL2BAN_GATE =="
if [ "$MODE" = "dry" ]; then
  test -f templates/vps/fail2ban/jail.local.example
  echo "PASS: dry"
  exit 0
fi
echo "STOP: vps mode is private-only"
exit 2

cat > scripts/vps/auditd_gate.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
MODE="${1:-dry}"
echo "== AUDITD_GATE =="
if [ "$MODE" = "dry" ]; then
  test -f templates/vps/auditd/gitnanu.rules.example
  echo "PASS: dry"
  exit 0
fi
echo "STOP: vps mode is private-only"
exit 2

cat > scripts/vps/backup_gate.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
MODE="${1:-dry}"
echo "== BACKUP_GATE =="
if [ "$MODE" = "dry" ]; then
  test -f templates/vps/cron/backup.cron.example
  echo "PASS: dry"
  exit 0
fi
echo "STOP: vps mode is private-only"
exit 2

cat > scripts/vps/restore_test_gate.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
MODE="${1:-dry}"
echo "== RESTORE_TEST_GATE =="
if [ "$MODE" = "dry" ]; then
  test -f docs/runbooks/RUNBOOK_BACKUP_RESTORE.md
  echo "PASS: dry"
  exit 0
fi
echo "STOP: vps mode is private-only"
exit 2

cat > scripts/vps/vps_gate.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
MODE="${1:-dry}"

TS="$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
COMMIT="$(git rev-parse --short HEAD)"

echo "== VPS_GATE =="
echo "MODE=${MODE}"
echo "TS=${TS}"
echo "COMMIT=${COMMIT}"

bash scripts/vps/ssh_gate.sh "${MODE}"
bash scripts/vps/firewall_gate.sh "${MODE}"
bash scripts/vps/fail2ban_gate.sh "${MODE}"
bash scripts/vps/auditd_gate.sh "${MODE}"
bash scripts/vps/backup_gate.sh "${MODE}"
bash scripts/vps/restore_test_gate.sh "${MODE}"

mkdir -p evidence/public
cat > evidence/public/VPS_GATE_REPORT.latest.md <<EOF
# VPS_GATE_REPORT (sanitized)
- timestamp_iso: ${TS}
- repo_commit: ${COMMIT}
- mode: ${MODE}
- result: PASS

echo "PASS: VPS_GATE ok"

chmod +x scripts/vps/*.sh

echo "DONE: VPS pack created."
